-- Extensions
CREATE EXTENSION IF NOT EXISTS pgcrypto;  -- gen_random_uuid()

-- Enums
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'memory_kind') THEN
    CREATE TYPE memory_kind AS ENUM (
      'preference',
      'profile',
      'fact',
      'rule',
      'summary',
      'other'
    );
  END IF;
END$$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'memory_scope') THEN
    CREATE TYPE memory_scope AS ENUM ('global', 'conversation');
  END IF;
END$$;

--------------------------
-- 1) Conversation + Summary
--------------------------
CREATE TABLE IF NOT EXISTS conversation (
  conversation_id   UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_key          TEXT,                                 -- user id/email/etc (optional)
  metadata          JSONB NOT NULL DEFAULT '{}'::jsonb,

  -- Concurrency + ordering (multi-container safe)
  last_step         BIGINT NOT NULL DEFAULT 0,

  -- Rolling summary (updated periodically by a worker or after N turns)
  summary           TEXT NOT NULL DEFAULT '',
  summary_updated_at TIMESTAMPTZ,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_conversation_user_key
  ON conversation(user_key);

--------------------------
-- 2) Checkpoints (resume state)
--------------------------
CREATE TABLE IF NOT EXISTS checkpoint (
  checkpoint_id     UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id   UUID NOT NULL REFERENCES conversation(conversation_id) ON DELETE CASCADE,

  step              BIGINT NOT NULL,                      -- monotonic per conversation
  state             JSONB NOT NULL,                       -- full structured state snapshot

  run_id            TEXT,
  tags              TEXT[] NOT NULL DEFAULT ARRAY[]::TEXT[],
  created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE(conversation_id, step)
);

CREATE INDEX IF NOT EXISTS idx_checkpoint_conv_created
  ON checkpoint(conversation_id, created_at DESC);

CREATE INDEX IF NOT EXISTS gin_checkpoint_state
  ON checkpoint USING GIN (state);

--------------------------
-- 3) Outbox queue (async memory writing)
--------------------------
CREATE TABLE IF NOT EXISTS memory_outbox (
  job_id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id   UUID NOT NULL REFERENCES conversation(conversation_id) ON DELETE CASCADE,

  payload           JSONB NOT NULL,                        -- what the memory-writer needs
  status            TEXT NOT NULL DEFAULT 'pending',        -- pending|processing|done|failed
  attempts          INT  NOT NULL DEFAULT 0,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_memory_outbox_pending
  ON memory_outbox(status, created_at);

--------------------------
-- 4) Durable Memory Store
--------------------------
CREATE TABLE IF NOT EXISTS memory_item (
  memory_id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Scope:
  -- global: applies across conversations for user_key
  -- conversation: applies only to a single conversation_id
  scope             memory_scope NOT NULL DEFAULT 'global',
  user_key          TEXT,                                  -- required for global memories
  conversation_id   UUID NULL REFERENCES conversation(conversation_id) ON DELETE CASCADE,

  kind              memory_kind NOT NULL,
  key               TEXT NOT NULL,                          -- stable handle (e.g., "diet.vegetarian")
  value             JSONB NOT NULL,                         -- canonical structured value
  text              TEXT,                                   -- human-readable

  confidence        REAL NOT NULL DEFAULT 0.7,               -- 0..1
  importance        REAL NOT NULL DEFAULT 0.5,               -- 0..1
  is_active         BOOLEAN NOT NULL DEFAULT TRUE,

  source            JSONB NOT NULL DEFAULT '{}'::jsonb,      -- provenance
  created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Dedupe:
  -- global memories are unique per (user_key, key)
  -- conversation memories are unique per (conversation_id, key)
  CONSTRAINT chk_memory_scope_keys CHECK (
    (scope = 'global' AND user_key IS NOT NULL AND conversation_id IS NULL)
    OR
    (scope = 'conversation' AND conversation_id IS NOT NULL)
  )
);

-- Partial unique indexes for dedupe (cleaner than one wide UNIQUE)
CREATE UNIQUE INDEX IF NOT EXISTS ux_memory_global_user_key_key
  ON memory_item(user_key, key)
  WHERE scope = 'global';

CREATE UNIQUE INDEX IF NOT EXISTS ux_memory_conversation_id_key
  ON memory_item(conversation_id, key)
  WHERE scope = 'conversation';

CREATE INDEX IF NOT EXISTS idx_memory_lookup
  ON memory_item(scope, user_key, conversation_id, kind, is_active);

CREATE INDEX IF NOT EXISTS gin_memory_value
  ON memory_item USING GIN (value);

-- Optional: append-only history
CREATE TABLE IF NOT EXISTS memory_version (
  version_id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  memory_id         UUID NOT NULL REFERENCES memory_item(memory_id) ON DELETE CASCADE,

  value             JSONB NOT NULL,
  text              TEXT,
  confidence        REAL,
  importance        REAL,
  is_active         BOOLEAN,

  write_reason      TEXT,
  source            JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_memory_version_memory_created
  ON memory_version(memory_id, created_at DESC);
